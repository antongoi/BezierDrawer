<html>
<head>
    <script>
        function onLoad() {
            this.controls = [];
            this.points = [];
            this.lines = [];
            this.imageObj = new Image();
            this.savedStates = [];
            this.currentSavedState = -1;
            draw();
        }
        function onMove(event) {
            for (var i = 0; i < this.points.length; i++) {
                this.points[i].checkHoverStatus(event);
            }
        }
        function onPress(event) {
            saveState();
            for (var i = 0; i < this.points.length; i++) {
                this.points[i].checkPressStatus(event);
            }
        }
        function onRelease(event) {
            saveState();
            for (var i = 0; i < this.points.length; i++) {
                this.points[i].checkReleaseStatus(event);
            }
        }

        function saveState() {
            var serializedData = document.getElementById("serializedLines").value;
            if (this.savedStates[this.currentSavedState] == serializedData) {
                return;
            }
            if (this.currentSavedState + 1 < this.savedStates.length) {
                this.savedStates = this.savedStates.slice(0, this.currentSavedState + 1);
            }
            this.savedStates = this.savedStates.concat(serializedData);
            this.currentSavedState++;
        }
        function undo() {
            if (this.currentSavedState > 0) {
                this.currentSavedState--;
                document.getElementById("serializedLines").value = this.savedStates[this.currentSavedState];
                deserializeLinesData();
            }
        }
        function redo() {
            if (this.currentSavedState + 1 < this.savedStates.length) {
                this.currentSavedState++;
                document.getElementById("serializedLines").value = this.savedStates[this.currentSavedState];
                deserializeLinesData();
            }
        }

        function add(control) {
            this.controls = this.controls.concat([control]);
        }
        function addPoints(control) {
            this.points = this.points.concat([control]);
        }
        function addLines(control) {
            this.lines = this.lines.concat([control]);
            var id = this.lines.indexOf(control);
            var option = document.createElement("option");
            option.text = "line_" + id;
            option.id = id;
            document.getElementById("selectLine").add(option);
        }
        function draw() {
            var p1 = new ControlPoint(800, 50, document.getElementById("myCanvas"));
            add(p1);
            addPoints(p1);
            var p2 = new ControlPoint(340, 440, document.getElementById("myCanvas"));
            add(p2);
            addPoints(p2);
            var p3 = new ControlPoint(500, 100, document.getElementById("myCanvas"));
            add(p3);
            addPoints(p3);
            var p4 = new ControlPoint(680, 365, document.getElementById("myCanvas"));
            add(p4);
            addPoints(p4);

            var l = new BezierCurve(p1, p2, p3, p4, document.getElementById("myCanvas").getContext("2d"));
            add(l);
            addLines(l);

            var op = new ControlPoint(0, 0, document.getElementById("myCanvas"));
            op.setOrigin(true);
            add(op);
            addPoints(op);

            this.viewController = new ViewController(document.getElementById("p1x"), document.getElementById("p1y"),
                    document.getElementById("p2x"), document.getElementById("p2y"),
                    document.getElementById("p3x"), document.getElementById("p3y"),
                    document.getElementById("p4x"), document.getElementById("p4y"), l,
                    op, document.getElementById("originX"), document.getElementById("originY"), document.getElementById("originActive"));
            globalRepaint();
        }
        function getViewController() {
            return this.viewController;
        }

        function globalClear() {
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            ctx.clearRect(0, 0, c.width, c.height);
        }
        function globalRepaint() {
            var ctx = document.getElementById('myCanvas').getContext('2d');
            ctx.drawImage(this.imageObj, 0, 0);
            var serializedTextBox = document.getElementById("serializedLines");
            var serializedString = "";
            document.getElementById("lineColorsHelp").innerHTML = "";
            for (var i = 0; i < this.lines.length; i++) {
                var line = this.lines[i];
                line.redraw();
                serializedString += line.getP1().x + "," + line.getP1().y + "," +
                        line.getP2().x + "," + line.getP2().y + "," +
                        line.getP3().x + "," + line.getP3().y + "," +
                        line.getP4().x + "," + line.getP4().y + "!" + line.color + "|";
                document.getElementById("lineColorsHelp").innerHTML += "<b style=\"color:" + line.color + ";\">LINE_" + i + "<" + "/b>, ";
            }
            getViewController().originPoint.redraw();
            updateTextArea(this.lines);
            serializedTextBox.value = serializedString;
//            for (var i = 0; i < this.points.length; i++) {
//                this.points[i].redraw();
//            }
        }
        function updateTextArea(lines) {
            var txtArea = document.getElementById("textArea");
            txtArea.value = "M p1.x p1.y C p3.x p3.y p4.x p4.y p2.x p2.y\n\n";
            var dx = getViewController().originActivity.checked ? getViewController().originPoint.getX() : 0;
            var dy = getViewController().originActivity.checked ? getViewController().originPoint.getY() : 0;
            for (var i = 0; i < lines.length; i++) {
                txtArea.value += "line_" + (i) + ":M" + (lines[i].getP1().getX() - dx) + "," + (lines[i].getP1().getY() - dy)
                        + "C" + (lines[i].getP3().getX() - dx) + "," + (lines[i].getP3().getY() - dy)
                        + "," + (lines[i].getP4().getX() - dx) + "," + (lines[i].getP4().getY() - dy)
                        + "," + (lines[i].getP2().getX() - dx) + "," + (lines[i].getP2().getY() - dy) + "\n";
            }
        }
        function deserializeLinesDataButton() {
            saveState();
            deserializeLinesData();
        }
        function deserializeLinesData() {
            getViewController().originPoint.setXY(0,0);
            this.imageObj = new Image();
            document.getElementById("loadFile").value = "";
            while (this.lines.length > 0) {
                removeLine();
            }
            var serializedData = document.getElementById("serializedLines").value;
            var linesData = serializedData.split("|");
            for (var i = 0; i < linesData.length - 1; i++) {
                var lineData = linesData[i];
                var color = lineData.split("!")[1];
                var points = lineData.split("!")[0].split(",");
                var p1 = new ControlPoint(parseInt(points[0]), parseInt(points[1]), document.getElementById("myCanvas"));
                var p2 = new ControlPoint(parseInt(points[2]), parseInt(points[3]), document.getElementById("myCanvas"));
                var p3 = new ControlPoint(parseInt(points[4]), parseInt(points[5]), document.getElementById("myCanvas"));
                var p4 = new ControlPoint(parseInt(points[6]), parseInt(points[7]), document.getElementById("myCanvas"));
                var l = createNewLineFromPoints(p1, p2, p3, p4);
                l.setColor(color);
                add(l);
                addLines(l);
                getViewController().focusToLine(this.lines[0]);
            }
            globalClear();
            globalRepaint();
        }
        function applyCoords() {
//                this.points[0].setXY(document.getElementById("p1x").value, document.getElementById("p1y").value);
//                this.points[1].setXY(document.getElementById("p2x").value, document.getElementById("p2y").value);
//                this.points[2].setXY(document.getElementById("p3x").value, document.getElementById("p3y").value);
//                this.points[3].setXY(document.getElementById("p4x").value, document.getElementById("p4y").value);
//                globalClear();
//                globalRepaint();
            this.viewController.applyNewCoords();
            saveState();
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }


        function coefficients() {
            var p1x = parseInt(document.getElementById("p1x").value);
            var p1y = parseInt(document.getElementById("p1y").value);
            var p2x = parseInt(document.getElementById("p2x").value);
            var p2y = parseInt(document.getElementById("p2y").value);
            var p3x = parseInt(document.getElementById("p3x").value);
            var p3y = parseInt(document.getElementById("p3y").value);
            var p4x = parseInt(document.getElementById("p4x").value);
            var p4y = parseInt(document.getElementById("p4y").value);
            var dx = getViewController().originActivity.checked ? getViewController().originPoint.getX() : 0;
            var dy = getViewController().originActivity.checked ? getViewController().originPoint.getY() : 0;

            document.getElementById("coefficients").innerHTML = "p3x = p1.x-(p1.x-p2.x)*" + ((p1x - p3x) / (p1x - p2x)) + "<br><br>" +
                    "p3y = p1.y-(p1.y-p2.y)*" + ((p1y - p3y) / (p1y - p2y)) + "<br><br>" +
                    "p4x = p1.x-(p1.x-p2.x)*" + ((p1x - p4x) / (p1x - p2x)) + "<br><br>" +
                    "p4y = p1.y-(p1.y-p2.y)*" + ((p1y - p4y) / (p1y - p2y));

            document.getElementById("coefficients").innerHTML += "\<br\>============\<br\>p3x = p1.x*" + ((p3x - dx) / (p1x - dx)) + "<br><br>" +
                    "p3y = p1.y*" + ((p3y - dy) / (p1y - dy)) + "<br><br>" +
                    "p4x = p1.x*" + ((p4x - dx) / (p1x - dx)) + "<br><br>" +
                    "p4y = p1.y*" + ((p4y - dy) / (p1y - dy));

            document.getElementById("coefficients").innerHTML += "\<br\>============\<br\>p3x = p2.x*" + ((p3x - dx) / (p2x - dx)) + "<br><br>" +
                    "p3y = p2.y*" + ((p3y - dy) / (p2y - dy)) + "<br><br>" +
                    "p4x = p2.x*" + ((p4x - dx) / (p2x - dx)) + "<br><br>" +
                    "p4y = p2.y*" + ((p4y - dy) / (p2y - dy));
        }
        function changeLineColor() {
            getViewController().getActiveLine().setColor(document.getElementById("lineColor").value);
            globalRepaint();
            saveState();
        }
        function activeLineChanged() {
            var cBox = document.getElementById("selectLine");
            getViewController().focusToLine(this.lines[cBox.options[cBox.selectedIndex].id]);
        }
        function addNewLine() {
            var p1 = new ControlPoint(getRandomInt(5, 900), getRandomInt(5, 600), document.getElementById("myCanvas"));
            var p2 = new ControlPoint(getRandomInt(5, 900), getRandomInt(5, 600), document.getElementById("myCanvas"));
            var p3 = new ControlPoint(getRandomInt(5, 900), getRandomInt(5, 600), document.getElementById("myCanvas"));
            var p4 = new ControlPoint(getRandomInt(5, 900), getRandomInt(5, 600), document.getElementById("myCanvas"));
            var l = createNewLineFromPoints(p1, p2, p3, p4);
            add(l);
            addLines(l);
            var cBox = document.getElementById("selectLine");
            cBox.selectedIndex = cBox.childElementCount - 1;
            getViewController().focusToLine(l);
            globalClear();
            globalRepaint();
            saveState();
        }
        function createNewLineFromPoints(p1, p2, p3, p4) {
            add(p1);
            addPoints(p1);
            add(p2);
            addPoints(p2);
            add(p3);
            addPoints(p3);
            add(p4);
            addPoints(p4);
            return new BezierCurve(p1, p2, p3, p4, document.getElementById("myCanvas").getContext("2d"));
        }
        function removeLine() {
            var cBox = document.getElementById("selectLine");
            var index = cBox.options[cBox.selectedIndex].id;
            this.points.splice(this.points.indexOf(this.lines[index].getP1()), 1);
            this.points.splice(this.points.indexOf(this.lines[index].getP2()), 1);
            this.points.splice(this.points.indexOf(this.lines[index].getP3()), 1);
            this.points.splice(this.points.indexOf(this.lines[index].getP4()), 1);
            this.controls.splice(this.points.indexOf(this.lines[index].getP1()), 1);
            this.controls.splice(this.points.indexOf(this.lines[index].getP2()), 1);
            this.controls.splice(this.points.indexOf(this.lines[index].getP3()), 1);
            this.controls.splice(this.points.indexOf(this.lines[index].getP4()), 1);
            this.controls.splice(this.lines.indexOf(this.lines[index]), 1);
            this.lines.splice(index, 1);
            cBox.removeChild(cBox[index]);
            for (var i = index; i < this.lines.length; i++) {
                cBox.options.item(i).id = cBox.options.item(i).id - 1;
            }
            if (cBox.selectedIndex > -1) {
                getViewController().focusToLine(this.lines[cBox.selectedIndex]);
            }
            saveState();
        }
        function addImageBg() {
            var files = document.getElementById("loadFile").files;
            if (FileReader && files && files.length) {
                var fr = new FileReader();
                var img = this.imageObj;
                fr.onload = function () {
                    img.src = fr.result;
                }
                fr.readAsDataURL(files[0]);
            }
        }
        function resizeCanvas() {
            var c = document.getElementById("myCanvas");
            c.width = document.getElementById("resizeW").value;
            c.height = document.getElementById("resizeH").value;
            globalClear();
            globalRepaint();
        }
    </script>
    <script src="baseclass.js"></script>
    <script src="script.js"></script>
</head>
<body onload="onLoad()">
<table cellspacing="5">
    <tr>
        <td style="border: dashed 1px #AAAAAA;"><label for="selectLine">Active line: </label>
            <select id="selectLine" style="width: 200px;" onchange="activeLineChanged()">
            </select>
        </td>
        <td style="border: dashed 1px #AAAAAA;"><label for="lineColor">Line color: </label><input id="lineColor"
                                                                                                  type="color"
                                                                                                  onchange="changeLineColor()">
        </td>
        <td style="border: dashed 1px #AAAAAA;"><input type="button" value="AddLine" onclick="addNewLine()"></td>
        <td style="border: dashed 1px #AAAAAA;"><input type="button" value="RemoveLine"
                                                       onclick="removeLine();globalClear();globalRepaint()"></td>
        <!--<td style="border: dashed 1px #AAAAAA;"><label for="activateLineOnPointClick" style="font-size: 12px;">Activate line
            when clicking on point:</label>
            <input id="activateLineOnPointClick" style="vertical-align: middle;" type="checkbox"></td>-->
        <td style="border: dashed 1px #AAAAAA;"><input id="loadFile" type="file" onchange="addImageBg()"></td>
        <td style="border: dashed 1px #AAAAAA;">
            <input type="number" id="resizeW" value="1000" style="width: 50px; height: 20px;">
            <input type="number" id="resizeH" value="600" style="width: 50px; height: 20px;">
            <input type="button" value="Resize" onclick="resizeCanvas()">
        </td>
        <td style="border: dashed 1px #AAAAAA;">
            <input type="button" value="<U" onclick="undo()">
            <input type="button" value="R>" onclick="redo()">
        </td>
    </tr>
</table>
<br>
<table width="1200">
    <tr>
        <td style="border: solid 1px black;" width="1000">
            <canvas id="myCanvas" width="1000" height="600" onmousemove="onMove(event)" onmousedown="onPress(event)"
                    onmouseup="onRelease(event)" style="cursor: pointer;"></canvas>
        </td>
        <td style="border: dotted 1px black; vertical-align: top;" align="center" width="1000">
            <table style="border: dotted 1px black;" cellpadding="0" cellspacing="0">
                <tr>
                    <td>P1</td>
                    <td>
                        <label for="p1x">X:</label><input type="number" id="p1x" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;"><br>
                        <label for="p1y">Y:</label><input type="number" id="p1y" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;">
                    </td>
                </tr>
            </table>
            <br>
            <table style="border: dotted 1px black;" cellpadding="0" cellspacing="0">
                <tr>
                    <td>P2</td>
                    <td>
                        <label for="p2x">X:</label><input type="number" id="p2x" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;"><br>
                        <label for="p2y">Y:</label><input type="number" id="p2y" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;">
                    </td>
                </tr>
            </table>
            <br>
            <table style="border: dotted 1px black;" cellpadding="0" cellspacing="0">
                <tr>
                    <td>P3</td>
                    <td>
                        <label for="p3x">X:</label><input type="number" id="p3x" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;"><br>
                        <label for="p3y">Y:</label><input type="number" id="p3y" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;">
                    </td>
                </tr>
            </table>
            <br>
            <table style="border: dotted 1px black;" cellpadding="0" cellspacing="0">
                <tr>
                    <td>P4</td>
                    <td>
                        <label for="p4x">X:</label><input type="number" id="p4x" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;"><br>
                        <label for="p4y">Y:</label><input type="number" id="p4y" value=""
                                                          style="width: 130px; height: 30px; background-color: transparent;">
                    </td>
                </tr>
            </table>
            <br><br>
            Origin point:<br>
            <label for="originX">X:</label><input type="number" id="originX" value="0" style="width: 70px; height: 20px;"><br>
            <label for="originY">Y:</label><input type="number" id="originY" value="0" style="width: 70px; height: 20px;"><br>
            <label for="originActive">Active:</label><input type="checkbox" id="originActive" onchange="getViewController().updateView()">
            <br><br>
            <br>
            <input type="button" value="ApplyCoords" style="width: 170px;" onclick="applyCoords()"><br>
            <br>
            <br>
            <br>
            <input type="button" value="Coefficients" style="width: 170px;" onclick="coefficients()"><br>
        </td>
        <td>
            <p style="font-size: 12px;" id="coefficients"></p>
        </td>
    </tr>
</table>
<input id="serializedLines" type="text" style="width: 500px;"><input type="button" value="DeSerialize"
                                                                     onclick="deserializeLinesDataButton()">

<p id="lineColorsHelp"></p>
<br><br>
<textarea id="textArea" rows="15" cols="100"></textarea>
</body>
</html>